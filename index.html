<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NANDI GURUKUL VIDYA MANDIR - Report Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* -------- PRINT STYLES - A4, watermark, footer positions, etc. -------- */
@media print {
body { -webkit-print-color-adjust: exact; }
.no-print { display: none !important; }
.screen-only { display: none !important; }
.print-only { display: block !important; } 

.page {
  width: 210mm;
  min-height: 297mm; 
  margin: 0 auto;
  padding: 5mm 12.7mm; 
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
  background: white;
  position: relative;
  page-break-inside: avoid; 
  -webkit-print-color-adjust: exact;
  display: flex; 
  flex-direction: column;
}

.page::before{
content: "";
position: absolute; 
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 60%;
height: 60%;
background-image: url('watermark.png'); 
background-repeat: no-repeat;
background-position: center;
background-size: contain;
opacity: 0.05;
pointer-events: none;
z-index: 0;
}

.page-content-wrapper {
  flex-grow: 1; 
  display: flex;
  flex-direction: column;
  min-height: calc(297mm - 10mm); 
  box-sizing: border-box;
}

.page-content-wrapper > .border-b {
    padding-bottom: 30px !important; 
    margin-bottom: 7px !important; 
}
.page-content-wrapper > .grid.grid-cols-4 {
    margin-bottom: 5px !important; 
}


.page-footer-area {
  margin-top: auto; 
  width: 100%;
  padding-top: 3mm; 
}

.page-footer-area, #finalFooter, #disclaimer, #printDate {
    color: black !important;
}
.muted { 
    color: black !important; 
}
.school-name-color { 
    color: black !important; 
}

#finalFooter {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  z-index: 2;
}
#finalFooter .col { 
    width: 33%; 
    box-sizing: border-box; 
    text-align: center; 
    display: flex; 
    flex-direction: column;
    justify-content: flex-end; 
    min-height: 80px; 
}
#finalFooter .left { text-align: left; }
#finalFooter .right { text-align: right; }

.signature-space { 
    flex-grow: 1; 
    display:block; 
}
.principal-img {
    height: 48px; 
    display: block; 
    margin: 0 auto 6px; 
    object-fit: contain;
}


#disclaimer {
  width: 100%;
  text-align: center;
  font-size: 10px;
  margin-top: 3px; 
  z-index: 2;
}
#printDate {
  width: 100%;
  text-align: center;
  font-size: 10px;
  margin-top: 2px; 
  z-index: 2;
}
table { page-break-inside:relative; }
tr { page-break-inside:avoid; page-break-after:relative; }
}

/* ---------------- SCREEN ---------------- */
body { background: #ffffff; }
.print-only { display: none; } 

.page { width: 900px; margin: 20px auto; padding: 18px; background: white; box-shadow: 0 6px 18px rgba(0,0,0,0.08); border: 2px solid #0f172a;
}
.page-content-wrapper, .page-footer-area {
  min-height: auto; 
  flex-grow: 1;
}

.school-name-color { color: #4f46e5; } 
.school-name { letter-spacing: 1px; }
input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.muted { color:#6b7280; font-size:0.95rem; } 
.signature-label { font-size:0.95rem; text-align:center; }
.signature-sign { font-weight:600; text-align:center; margin-top:8px; }
table input[type="number"] { text-align:center; }
select.grade-select { padding:4px; border-radius:4px; }
</style>
</head>
<body class="bg-gray-100 p-6">
<div class="no-print mb-4 p-4 bg-yellow-100 border rounded">
<h2 class="font-bold mb-2">School Dashboard (Topper Analysis)</h2>
<label class="block text-sm text-gray-600 mb-1">Select Class to See Topper:</label>
<select id="dashboardClassSelect" class="border rounded px-2 py-1 mb-2">
<option value="">-- Select Class --</option>
<option value="Nursery">Nursery</option>
<option value="LKG">LKG</option>
<option value="UKG">UKG</option>
<option value="1">I</option>
<option value="2">II</option>
<option value="3">III</option>
<option value="4">IV</option>
<option value="5">V</option>
<option value="6">VI</option>
<option value="7">VII</option>
<option value="8">VIII</option>
<option value="9">IX</option>
</select>
<p id="classTopperDashboard" class="font-semibold mt-1">Class Topper: —</p>
<p id="schoolTopperDashboard" class="font-semibold mt-1">School Topper: —</p>
<div class="mt-3 flex gap-2">
<button id="bulkDownloadBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Download Classwise Report Cards</button>
<button id="downloadExcelBtn" class="px-3 py-1 bg-green-700 text-white rounded">Download Classwise Marks (Excel)</button>
<button id="setNewLoginPassBtn" class="px-3 py-1 bg-yellow-600 text-white rounded">Set New Login Password</button>
</div>
</div>
<div class="page">
  <div class="page-content-wrapper">
    <div class="pb-6 border-b mb-6 relative">
        <img src="logo.png" class="w-24 h-24 rounded-md absolute top-0 left-3" alt="School Logo" />

        <div class="text-center ml-[112px] mr-[112px]"> 
            <h1 class="text-2xl font-extrabold school-name school-name-color">NANDI GURUKUL VIDYA MANDIR</h1>
            <p class="text-sm">Academic Session: <strong>2025-26</strong></p>
            <!-- MODIFICATION: Changed title to Annual Examination -->
            <p class="text-sm mt-1 text-gray-700 font-semibold">REPORT CARD - ANNUAL EXAMINATION</p>
        </div>

        <div class="text-right no-print absolute top-0 right-0">
            <label class="block text-xs text-gray-600">Select Class</label>
            <select id="classSelect" class="border rounded px-2 py-1 bg-white">
            <option value="">-- Select Class --</option>
            <option value="Nursery">Nursery</option>
            <option value="LKG">LKG</option>
            <option value="UKG">UKG</option>
            <option value="1">I</option>
            <option value="2">II</option>
            <option value="3">III</option>
            <option value="4">IV</option>
            <option value="5">V</option>
            <option value="6">VI</option>
            <option value="7">VII</option>
            <option value="8">VIII</option>
            <option value="9">IX</option>
            </select>
        </div>
    </div>
    <div class="no-print mb-4">
    <div class="grid grid-cols-5 gap-4 items-end">
    <div>
    <label class="text-sm text-gray-600">Admission Number</label>
    <input id="admissionInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="e.g. 138/Z18" />
    </div>
    <div>
    <label class="text-sm text-gray-600">Student Name</label>
    <input id="studentNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Student full name" />
    </div>
    <div>
    <label class="text-sm text-gray-600">Father's Name</label>
    <input id="fatherNameInput" type="text" class="border px-2 py-1 rounded w-full" placeholder="Father's full name" />
    </div>
    <div class="col-span-2 flex gap-2 justify-end">
    <button id="loadBtn" class="px-3 py-1 border rounded">Load</button>
    <button id="saveBtn" class="px-3 py-1 bg-green-600 text-white rounded">Save</button>
    <button id="addStudentBtn" class="px-3 py-1 bg-blue-600 text-white rounded">Add / Update</button>
    <button id="printBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Print</button>
    </div>
    </div>
    <div class="mt-4 flex gap-4 items-center">
        <div>
            <label class="text-sm text-gray-600">Report Print Date (Optional)</label>
            <input id="reportPrintDateInput" type="date" class="border px-2 py-1 rounded" />
        </div>
        <button id="setPrintDateBtn" class="px-3 py-1 border rounded self-end">Set Date</button>
    </div>
    </div>
    <div class="grid grid-cols-4 gap-4 mb-4 mt-4">
    <div>
    <p class="text-sm text-gray-600">Admission No.</p>
    <h2 id="admissionNo" class="font-semibold">—</h2>
    </div>
    <div>
    <p class="text-sm text-gray-600">Name</p>
    <h2 id="studentName" class="font-semibold">—</h2>
    </div>
    <div>
    <p class="text-sm text-gray-600">Father's Name</p>
    <h2 id="fatherName" class="font-semibold">—</h2>
    </div>
    <div>
    <p class="text-sm text-gray-600">Class/Section</p>
    <h2 id="classSection" class="font-semibold">—</h2>
    </div>
    </div>
    
    <div class="mb-4">
    <label class="text-sm text-gray-600 font-semibold">Attendance</label>
    <div class="flex gap-2 items-center">
    <input type="number" id="attendancePresent" min="0" max="220" placeholder="Days Present" class="border px-2 py-1 rounded w-32" />
    <input type="number" id="attendanceTotal" readonly value="220" class="border px-2 py-1 rounded w-40 bg-gray-200 text-center" title="Total working days" />
    </div>
    </div>
    
    <div class="overflow-x-auto">
    <table id="marksTable" class="w-full border-collapse table-auto text-sm">
    <thead id="marksTableHead"></thead>
    <tbody id="marksTableBody"></tbody>
    <tfoot id="marksTableFoot"></tfoot>
    </table>
    </div>
    <div class="grid grid-cols-3 gap-4 mt-6"> 
    <div class="col-span-1">
    <div class="border p-4">
    <h3 class="font-semibold mb-2">Co-Scholastic Grades </h3>
    <table class="w-full text-sm" id="coscholasticTable">
    <tbody id="coscholasticBody">
    <tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
    <tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
    </tbody>
    </table>
    </div>
    <div class="border p-4 mt-4">
    <h3 class="font-semibold mb-2">Class Teacher's Remark</h3>
    <div id="teachersRemark" class="w-full p-2 text-sm border rounded bg-gray-50">Good effort. Keep improving.</div>
    </div>
    </div>
    <div class="col-span-2">
    <div class="border p-4">
    <h3 class="font-semibold mb-2">Graphical Analysis (Annual)</h3>
    <canvas id="marksChart" height="180"></canvas>
    </div>
    </div>
    </div>
  </div>
  <div class="page-footer-area">
    <!-- MODIFICATION: Added Final Result display -->
    <div class="text-center font-bold text-lg mb-2" id="finalResult">Final Result: —</div>
    <div id="finalFooter" style="display:flex; justify-content:space-between; align-items:flex-start;">
    <div class="col left" style="text-align:left;">
    <div class="signature-space"></div>
    <div class="signature-label">Class Teacher</div>
    </div>
    <div class="col" style="text-align:center;">
    <div class="signature-space"></div>
    <div class="signature-label">School Seal</div>
    </div>
    <div class="col right" style="text-align:right;">
    <img src="principal.png" alt="Principal" class="principal-img" />
    <div class="signature-label">Principal</div>
    </div>
    </div>
    <div id="disclaimer" class="muted text-center">
    *This digitally generated report card is a bonafide record of student's academic performance.
    </div>
    <div id="printDate" class="text-center muted">Date: —</div>
  </div>
  </div>
<div class="no-print text-center mt-6">
<button id="clearDataBtn" class="px-3 py-1 bg-red-600 text-white rounded">Clear All Data (Requires Password)</button>
</div>
<script>
/* ---------------- MODIFICATION: CONFIG & SUBJECTS FOR ANNUAL EXAM ---------------- */
const SUBJECTS_NUR_TO_UKG = [
{ name: "English", max: { ut1: 15, ut1Oral: 5, hy: 60, hyOral: 20, ut2: 15, ut2Oral: 5, ae: 60, aeOral: 20 } },
{ name: "Hindi", max: { ut1: 15, ut1Oral: 5, hy: 60, hyOral: 20, ut2: 15, ut2Oral: 5, ae: 60, aeOral: 20 } },
{ name: "Maths", max: { ut1: 15, ut1Oral: 5, hy: 60, hyOral: 20, ut2: 15, ut2Oral: 5, ae: 60, aeOral: 20 } },
{ name: "Drawing", max: { ut1: 20, ut1Oral: 0, hy: 80, hyOral: 0, ut2: 20, ut2Oral: 0, ae: 80, aeOral: 0 } }
];
const SUBJECTS_1_TO_5 = ["Hindi", "English", "Mathematics", "Computer", "E.V.S.", "Drawing", "G.K."];
const SUBJECTS_6_TO_8 = ["Hindi", "English", "Mathematics", "Computer", "Drawing", "G.K.", "Science", "S.S.T."];
const SUBJECTS_9 = ["Hindi", "English", "Mathematics", "Science", "S.S.T.", "Drawing"];
const DEFAULT_ATT_TOTAL = 220; // Changed for Annual

const LOGIN_PASSWORD_KEY = 'ng_loginPassword';
const DEFAULT_LOGIN_PASSWORD = '2006';
const ADMIN_PASSWORD = '1234';

/* ---------------- STATE ---------------- */
let state = {
selectedClass: '',
selectedStudentKey: '',
studentsByClass: {},
chart: null,
reportPrintDate: null,
loginPassword: DEFAULT_LOGIN_PASSWORD
};
/* ---------------- UTIL ---------------- */
const qs = id => document.getElementById(id);

/* ---------------- INIT ---------------- */
function init() {
    if (!checkLogin()) return;

    const stored = localStorage.getItem('ng_students');
    state.studentsByClass = stored ? JSON.parse(stored) : {};
    
    const storedPass = localStorage.getItem(LOGIN_PASSWORD_KEY);
    state.loginPassword = storedPass || DEFAULT_LOGIN_PASSWORD;

    const storedDate = localStorage.getItem('ng_reportPrintDate');
    if (storedDate) {
        state.reportPrintDate = storedDate;
        qs('reportPrintDateInput').value = storedDate;
    }
    attachEventListeners();
    initChart();
    updatePrintDate();
    renderMarksTableForClass('');
}

/* ---------------- LOGIN FUNCTIONS ---------------- */

function checkLogin() {
    const storedPass = localStorage.getItem(LOGIN_PASSWORD_KEY);
    state.loginPassword = storedPass || DEFAULT_LOGIN_PASSWORD;
    document.body.style.display = 'none'; 
    let password = prompt('Enter Login Password:'); 

    if (password === state.loginPassword) {
        document.body.style.display = 'block';
        return true;
    } else {
        document.body.style.display = 'block'; 
        alert('Incorrect Password! Access Denied.');
        document.body.innerHTML = '<div style="margin: 50px; text-align: center;"><h1 style="color: red;">ACCESS DENIED. Incorrect Password.</h1></div>';
        return false;
    }
}

function changeLoginPassword() {
    const adminPass = prompt('Enter Admin Password to change Login Password:'); 
    if (adminPass !== ADMIN_PASSWORD) return alert('Incorrect Admin Password!');
    const newPass = prompt('Enter New Login Password:');
    if (!newPass || newPass.trim() === '') return alert('New password cannot be empty.');
    state.loginPassword = newPass;
    localStorage.setItem(LOGIN_PASSWORD_KEY, newPass);
    alert(`Login Password successfully updated to: ${newPass}. Please remember it for the next login.`);
}
/* ---------------- MAP & HELPERS ---------------- */
function interpretClassValue(val) {
if (!val) return '';
const romanMap = { "I":"1","II":"2","III":"3","IV":"4","V":"5","VI":"6","VII":"7","VIII":"8","IX":"9" };
if (romanMap[val]) return romanMap[val];
return val;
}
function displayClassLabel(cls) {
if (!cls) return '—';
if (cls === 'Nursery' || cls === 'LKG' || cls === 'UKG') return cls;
const map = {1:'I',2:'II',3:'III',4:'IV',5:'V',6:'VI',7:'VII',8:'VIII',9:'IX'};
return map[Number(cls)] || cls;
}
/* ---------------- EVENT LISTENERS ---------------- */
function attachEventListeners() {
qs('classSelect').addEventListener('change', e => {
const val = interpretClassValue(e.target.value);
state.selectedClass = val;
qs('classSection').textContent = displayClassLabel(val);
clearStudentView();
renderMarksTableForClass(val);
});
qs('addStudentBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const name = qs('studentNameInput').value.trim();
if (!name) return alert('Enter Student Name.');
const fatherName = qs('fatherNameInput').value.trim();
const key = `${state.selectedClass}|${admission}`;
state.studentsByClass[state.selectedClass] = state.studentsByClass[state.selectedClass] || {};
const student = makeEmptyStudent(name, admission, state.selectedClass, fatherName);
if (state.studentsByClass[state.selectedClass][key]) {
const ex = state.studentsByClass[state.selectedClass][key];
student.marks = ex.marks || student.marks;
student.attendance = ex.attendance || ex.attendance;
student.coscholastic = ex.coscholastic || student.coscholastic;
student.teachersRemark = ex.teachersRemark || student.teachersRemark;
student.fatherName = fatherName || ex.fatherName || student.fatherName;
}
state.studentsByClass[state.selectedClass][key] = student;
persistStudents();
state.selectedStudentKey = key;
loadStudent(key);
alert('Student added/updated. You may now enter marks and save.');
});
qs('loadBtn').addEventListener('click', () => {
if (!state.selectedClass) return alert('Select Class first.');
const admission = qs('admissionInput').value.trim();
if (!admission) return alert('Enter Admission Number.');
const key = `${state.selectedClass}|${admission}`;
if (!state.studentsByClass[state.selectedClass] || !state.studentsByClass[state.selectedClass][key]) {
return alert('Student not found. Add student first.');
}
state.selectedStudentKey = key;
loadStudent(key);
});
qs('saveBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
saveCurrentStudent();
alert('Saved locally.');
});
qs('printBtn').addEventListener('click', () => {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
calculateTotalsAndUpdate();
window.print();
});
qs('dashboardClassSelect').addEventListener('change', showDashboardTopper);
qs('bulkDownloadBtn').addEventListener('click', bulkDownloadReports);
qs('downloadExcelBtn').addEventListener('click', downloadMarksExcel);
qs('setPrintDateBtn').addEventListener('click', setReportPrintDate);
qs('setNewLoginPassBtn').addEventListener('click', changeLoginPassword);
qs('clearDataBtn').addEventListener('click', clearAllData);
}
/* ---------------- PERSISTENCE ---------------- */
function persistStudents() {
localStorage.setItem('ng_students', JSON.stringify(state.studentsByClass));
}
/* ---------------- MODIFICATION: STUDENT FACTORY FOR ANNUAL EXAM ---------------- */
function makeEmptyStudent(name, admission, cls, fatherName='') {
const marks = [];
if (isNurToUkg(cls)) {
SUBJECTS_NUR_TO_UKG.forEach(s => {
marks.push({
name: s.name,
ut1: 0, ut1Oral: 0, hy: 0, hyOral: 0,
ut2: 0, ut2Oral: 0, ae: 0, aeOral: 0,
max: s.max
});
});
} else {
const subs = subjectsForClass(cls);
subs.forEach(s => {
if (s === 'G.K.') {
marks.push({ name: s, grade: 'A', isGrade: true });
} else {
marks.push({ 
    name: s, ut1: 0, hy: 0, ut2: 0, ae: 0, isGrade: false,
    max: { ut1: 20, hy: 80, ut2: 20, ae: 80 }
});
}
});
}
return {
name, admission, cls, fatherName, marks,
coscholastic: {},
attendance: { present: 0, total: DEFAULT_ATT_TOTAL },
teachersRemark: 'Good effort. Keep improving.',
remark: ''
};
}
function isNurToUkg(cls) {
return cls === 'Nursery' || cls === 'LKG' || cls === 'UKG';
}
function subjectsForClass(cls) {
const n = Number(cls);
if (n >=1 && n <=5) return SUBJECTS_1_TO_5.slice();
if (n >=6 && n <=8) return SUBJECTS_6_TO_8.slice();
if (n === 9) return SUBJECTS_9.slice();
return [];
}
/* ---------------- MODIFICATION: RENDER MARKS TABLE FOR ANNUAL EXAM ---------------- */
function renderMarksTableForClass(cls) {
const thead = qs('marksTableHead');
const tbody = qs('marksTableBody');
const tfoot = qs('marksTableFoot');
tbody.innerHTML = '';
tfoot.innerHTML = '';
if (!cls) {
thead.innerHTML = `<tr><th class="border px-3 py-2 text-left">Select a class to begin</th></tr>`;
return;
}
if (isNurToUkg(cls)) {
thead.innerHTML = `
<tr class="bg-green-100">
<th rowspan="2" class="border px-2 py-1 align-middle text-left">Subject</th>
<th colspan="5" class="border px-2 py-1 text-center">Term 1</th>
<th colspan="5" class="border px-2 py-1 text-center">Term 2</th>
<th colspan="3" rowspan="2" class="border px-2 py-1 align-middle text-center">Overall</th>
</tr>
<tr class="bg-green-50 text-xs">
<th class="border px-1">UT1</th><th class="border px-1">Oral</th>
<th class="border px-1">HY</th><th class="border px-1">Oral</th><th class="border px-1 font-bold">Total</th>
<th class="border px-1">UT2</th><th class="border px-1">Oral</th>
<th class="border px-1">AE</th><th class="border px-1">Oral</th><th class="border px-1 font-bold">Total</th>
</tr>`;
const student = getCurrentStudent();
const marksData = student ? student.marks : SUBJECTS_NUR_TO_UKG.map(s => ({ name: s.name, max: s.max }));
marksData.forEach((m, idx) => {
    tbody.insertAdjacentHTML('beforeend', `
    <tr>
        <td class="border px-2 py-1">${m.name}</td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ut1" type="number" min="0" max="${m.max.ut1}" value="${m.ut1||0}" class="w-10 p-1 border rounded" /></td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ut1Oral" type="number" min="0" max="${m.max.ut1Oral}" value="${m.ut1Oral||0}" class="w-10 p-1 border rounded" ${m.max.ut1Oral===0?'disabled':''}/></td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="hy" type="number" min="0" max="${m.max.hy}" value="${m.hy||0}" class="w-10 p-1 border rounded" /></td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="hyOral" type="number" min="0" max="${m.max.hyOral}" value="${m.hyOral||0}" class="w-10 p-1 border rounded" ${m.max.hyOral===0?'disabled':''}/></td>
        <td class="border px-1 py-1 text-center font-bold">${m.t1_total||0}</td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ut2" type="number" min="0" max="${m.max.ut2}" value="${m.ut2||0}" class="w-10 p-1 border rounded" /></td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ut2Oral" type="number" min="0" max="${m.max.ut2Oral}" value="${m.ut2Oral||0}" class="w-10 p-1 border rounded" ${m.max.ut2Oral===0?'disabled':''}/></td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ae" type="number" min="0" max="${m.max.ae}" value="${m.ae||0}" class="w-10 p-1 border rounded" /></td>
        <td class="border px-1 py-1"><input data-idx="${idx}" data-field="aeOral" type="number" min="0" max="${m.max.aeOral}" value="${m.aeOral||0}" class="w-10 p-1 border rounded" ${m.max.aeOral===0?'disabled':''}/></td>
        <td class="border px-1 py-1 text-center font-bold">${m.t2_total||0}</td>
        <td class="border px-1 py-1 text-center font-semibold">${m.grand_total||0}</td>
        <td class="border px-1 py-1 text-center font-semibold">${(m.percentage||0).toFixed(1)}%</td>
        <td class="border px-1 py-1 text-center font-semibold">${m.grade||'--'}</td>
    </tr>`);
});
} else { // Classes 1-9
thead.innerHTML = `
<tr class="bg-green-100">
    <th rowspan="2" class="border px-2 py-1 align-middle text-left">Subject</th>
    <th colspan="3" class="border px-2 py-1 text-center">Term 1</th>
    <th colspan="3" class="border px-2 py-1 text-center">Term 2</th>
    <th colspan="3" rowspan="2" class="border px-2 py-1 align-middle text-center">Overall Performance</th>
</tr>
<tr class="bg-green-50 text-xs">
    <th class="border px-1">UT1 (20)</th><th class="border px-1">HY (80)</th><th class="border px-1 font-bold">Total (100)</th>
    <th class="border px-1">UT2 (20)</th><th class="border px-1">AE (80)</th><th class="border px-1 font-bold">Total (100)</th>
</tr>`;
const subs = subjectsForClass(cls);
const student = getCurrentStudent();
subs.forEach((s, idx) => {
    const mark = student ? student.marks[idx] : null;
    if (s === 'G.K.') {
        tbody.insertAdjacentHTML('beforeend', `<tr><td class="border px-2 py-1">${s}</td><td colspan="9" class="border px-2 py-1 text-center"><select data-idx="${idx}" data-field="grade" class="grade-select"><option value="A"${(mark&&mark.grade==='A')?' selected':''}>A</option><option value="B"${(mark&&mark.grade==='B')?' selected':''}>B</option><option value="C"${(mark&&mark.grade==='C')?' selected':''}>C</option><option value="D"${(mark&&mark.grade==='D')?' selected':''}>D</option></select></td></tr>`);
    } else {
        tbody.insertAdjacentHTML('beforeend', `
        <tr>
            <td class="border px-2 py-1">${s}</td>
            <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ut1" type="number" min="0" max="20" value="${mark?mark.ut1||0:0}" class="w-12 p-1 border rounded" /></td>
            <td class="border px-1 py-1"><input data-idx="${idx}" data-field="hy" type="number" min="0" max="80" value="${mark?mark.hy||0:0}" class="w-12 p-1 border rounded" /></td>
            <td class="border px-1 py-1 text-center font-bold">${mark?mark.t1_total||0:0}</td>
            <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ut2" type="number" min="0" max="20" value="${mark?mark.ut2||0:0}" class="w-12 p-1 border rounded" /></td>
            <td class="border px-1 py-1"><input data-idx="${idx}" data-field="ae" type="number" min="0" max="80" value="${mark?mark.ae||0:0}" class="w-12 p-1 border rounded" /></td>
            <td class="border px-1 py-1 text-center font-bold">${mark?mark.t2_total||0:0}</td>
            <td class="border px-1 py-1 text-center font-semibold">${mark?mark.grand_total||0:0}</td>
            <td class="border px-1 py-1 text-center font-semibold">${(mark?(mark.percentage||0):0).toFixed(1)}%</td>
            <td class="border px-1 py-1 text-center font-semibold">${mark?mark.grade||'--': '--'}</td>
        </tr>`);
    }
});
}
tfoot.innerHTML = `<tr class="bg-gray-50 font-bold"><td colspan="7" class="border px-3 py-2 text-right">Overall Total:</td><td id="grandTotal" class="border px-3 py-2 text-center">0</td><td id="finalPercentage" class="border px-3 py-2 text-center">0%</td><td id="finalGrade" class="border px-3 py-2 text-center">--</td></tr>`;
attachMarksInputsListeners();
calculateTotalsAndUpdate();
}
/* ---------------- ATTACH INPUT LISTENERS & VALIDATION ---------------- */
function attachMarksInputsListeners() {
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
el.addEventListener('input', e => {
autoClampInput(el);
calculateTotalsAndUpdate();
});
el.addEventListener('blur', () => { autoClampInput(el); calculateTotalsAndUpdate(); });
});
}
function autoClampInput(el) {
if (!el) return;
if (el.tagName.toLowerCase() === 'select') return;
const max = Number(el.max);
const min = Number(el.min) || 0;
let val = Number(el.value);
if (isNaN(val)) {
el.value = '';
return;
}
if (!isNaN(max) && max >= 0 && val > max) el.value = max;
if (!isNaN(min) && val < min) el.value = min;
}
/* ---------------- LOAD / SAVE STUDENT ---------------- */
function loadStudent(key) {
const [cls, admission] = key.split('|');
const student = state.studentsByClass[cls] && state.studentsByClass[cls][key];
if (!student) return alert('Student data not found.');
state.selectedStudentKey = key;
state.selectedClass = cls;
const romanMap = { "1":"I","2":"II","3":"III","4":"IV","5":"V","6":"VI","7":"VII","8":"VIII","9":"IX" };
qs('classSelect').value = (cls in romanMap) ? romanMap[cls] : cls;

qs('studentName').textContent = student.name;
qs('admissionNo').textContent = student.admission || '—';
qs('classSection').textContent = displayClassLabel(student.cls);
qs('fatherName').textContent = student.fatherName || '—';
qs('studentNameInput').value = student.name;
qs('admissionInput').value = student.admission || '';
if (qs('fatherNameInput')) qs('fatherNameInput').value = student.fatherName || '';
qs('attendancePresent').value = student.attendance.present || 0;
qs('attendanceTotal').value = student.attendance.total || DEFAULT_ATT_TOTAL;

renderMarksTableForClass(student.cls); // This now renders with saved values
student.coscholastic = student.coscholastic || {};
qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" value="${student.coscholastic.workHabits || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" value="${student.coscholastic.behavior || ''}" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
`;
calculateTotalsAndUpdate();
}
function saveCurrentStudent() {
if (!state.selectedStudentKey) return alert('Load or add a student first.');
const student = getCurrentStudent();
if (!student) return;
student.attendance.present = Number(document.getElementById('attendancePresent').value) || 0;
student.attendance.total = Number(document.getElementById('attendanceTotal').value) || DEFAULT_ATT_TOTAL;
student.fatherName = qs('fatherNameInput') ? qs('fatherNameInput').value.trim() : '';
student.coscholastic = {
workHabits: qs('workHabitsInput') ? qs('workHabitsInput').value.trim() : '',
behavior: qs('behaviorInput') ? qs('behaviorInput').value.trim() : ''
};
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
const idx = Number(el.getAttribute('data-idx'));
const field = el.getAttribute('data-field');
if (!Number.isFinite(idx)) return;
student.marks[idx] = student.marks[idx] || {};
if (el.tagName.toLowerCase() === 'select') {
student.marks[idx].grade = el.value;
student.marks[idx].isGrade = true;
} else {
student.marks[idx][field] = Number(el.value) || 0;
}
});
calculateTotalsAndUpdate();
persistStudents();
}
/* ---------------- GET STUDENT ---------------- */
function getCurrentStudent() {
if (!state.selectedStudentKey) return null;
const [cls] = state.selectedStudentKey.split('|');
return state.studentsByClass[cls] && state.studentsByClass[cls][state.selectedStudentKey];
}
/* ---------------- MODIFICATION: CALCULATIONS FOR ANNUAL EXAM ---------------- */
function getGrade(percentage) {
    if (percentage >= 91) return 'A1';
    if (percentage >= 81) return 'A2';
    if (percentage >= 71) return 'B1';
    if (percentage >= 61) return 'B2';
    if (percentage >= 51) return 'C1';
    if (percentage >= 41) return 'C2';
    if (percentage >= 33) return 'D';
    return 'E';
}

function calculateTotalsAndUpdate() {
const student = getCurrentStudent();
if (!student) return;

// Collect latest marks from inputs
qs('marksTableBody').querySelectorAll('input, select').forEach(el => {
    const idx = Number(el.getAttribute('data-idx'));
    const field = el.getAttribute('data-field');
    if (!Number.isFinite(idx) || !student.marks[idx]) return;
    if (el.tagName.toLowerCase() === 'select') student.marks[idx].grade = el.value;
    else student.marks[idx][field] = Number(el.value) || 0;
});

let grandTotal = 0;
let maxTotal = 0;
let isFail = false;

student.marks.forEach(m => {
    if (m.isGrade) return; // Skip G.K.

    let maxSubjTotal = 0;
    if(isNurToUkg(student.cls)) {
        m.t1_total = (m.ut1||0) + (m.ut1Oral||0) + (m.hy||0) + (m.hyOral||0);
        m.t2_total = (m.ut2||0) + (m.ut2Oral||0) + (m.ae||0) + (m.aeOral||0);
        maxSubjTotal = (m.max.ut1 + m.max.ut1Oral + m.max.hy + m.max.hyOral + m.max.ut2 + m.max.ut2Oral + m.max.ae + m.max.aeOral);
    } else {
        m.t1_total = (m.ut1||0) + (m.hy||0);
        m.t2_total = (m.ut2||0) + (m.ae||0);
        maxSubjTotal = 200;
    }
    
    m.grand_total = m.t1_total + m.t2_total;
    m.percentage = maxSubjTotal > 0 ? (m.grand_total / maxSubjTotal) * 100 : 0;
    m.grade = getGrade(m.percentage);

    if (m.grade === 'E') isFail = true;

    grandTotal += m.grand_total;
    maxTotal += maxSubjTotal;
});

const finalPercentage = maxTotal > 0 ? (grandTotal / maxTotal) * 100 : 0;
const finalGrade = getGrade(finalPercentage);
const finalResult = isFail ? 'NEEDS IMPROVEMENT' : 'PROMOTED TO NEXT CLASS';

// Update student object
student.remark = finalGrade;
student.teachersRemark = getRemarkText(finalPercentage);

// Re-render the entire table with new calculated values
renderMarksTableForClass(student.cls);

// Update footer totals
qs('grandTotal').textContent = grandTotal;
qs('finalPercentage').textContent = finalPercentage.toFixed(2) + '%';
qs('finalGrade').textContent = finalGrade;
qs('teachersRemark').textContent = student.teachersRemark;
qs('finalResult').textContent = `Final Result: ${finalResult}`;

updateChart(student);
}

function getRemarkText(p) {
    if (p >= 90) return 'Outstanding';
    else if (p >= 80) return 'Excellent';
    else if (p >= 70) return 'Very Good';
    else if (p >= 60) return 'Good';
    else if (p >= 50) return 'Average';
    return 'Needs Improvement';
}
/* ----------------- CHART ----------------- */
const CHART_COLORS = {
    OBTAINED: 'rgba(0, 0, 0, 1)',
    AVG: 'rgba(107, 114, 128, 1)',
    HIGHEST: 'rgba(255, 255, 255, 1)',
    STROKE: 'rgba(0, 0, 0, 1)'
};

function initChart() {
const ctx = qs('marksChart').getContext('2d');
state.chart = new Chart(ctx, {
type: 'bar',
data: { labels: [], datasets: [] },
options: { 
    responsive: true, 
    plugins:{ legend: { display: true } }, 
    scales:{ y: { beginAtZero:true, max:100 } }, // MODIFICATION: Max is now percentage
    categoryPercentage: 0.9, 
    barPercentage: 0.8
}
});
}
// MODIFICATION: Chart now shows final percentage per subject
function updateChart(student) {
const labels = student.marks.filter(m => !m.isGrade).map(m => m.name);
const obtained = student.marks.filter(m => !m.isGrade).map(m => m.percentage || 0);
const classAvg = labels.map(l => getClassAverage(student.cls, l, 'percentage'));
const classHigh = labels.map(l => getClassHighest(student.cls, l, 'percentage'));

state.chart.data.labels = labels;
state.chart.data.datasets = [
{ label: 'Obtained (%)', data: obtained, backgroundColor: CHART_COLORS.OBTAINED, borderColor: CHART_COLORS.STROKE, borderWidth: 1 },
{ label: 'Class Avg (%)', data: classAvg, backgroundColor: CHART_COLORS.AVG, borderColor: CHART_COLORS.STROKE, borderWidth: 1 },
{ label: 'Class High (%)', data: classHigh, backgroundColor: CHART_COLORS.HIGHEST, borderColor: CHART_COLORS.STROKE, borderWidth: 1 }
];
state.chart.update();
}
// MODIFICATION: Can calculate avg/high on any field (e.g., grand_total or percentage)
function getClassAverage(cls, subjectName, field = 'grand_total') {
if (!state.studentsByClass[cls]) return 0;
const vals = Object.values(state.studentsByClass[cls]).map(s => {
const sub = s.marks.find(m => m.name === subjectName);
return sub ? (sub[field] || 0) : 0;
}).filter(v => typeof v === 'number');
if (!vals.length) return 0;
return Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
}
function getClassHighest(cls, subjectName, field = 'grand_total') {
if (!state.studentsByClass[cls]) return 0;
const vals = Object.values(state.studentsByClass[cls]).map(s => {
const sub = s.marks.find(m => m.name === subjectName);
return sub ? (sub[field] || 0) : 0;
}).filter(v => typeof v === 'number');
if (!vals.length) return 0;
return Math.max(...vals);
}
/* ---------------- DASHBOARD TOPPER ---------------- */
function showDashboardTopper() {
const cls = qs('dashboardClassSelect').value;
if (!cls) { qs('classTopperDashboard').textContent='Class Topper: —'; qs('schoolTopperDashboard').textContent='School Topper: —'; return; }
let classTopper = { name:'—', total:0 };
let schoolTopper = { name:'—', total:0 };
// MODIFICATION: Topper is based on grand_total
Object.values(state.studentsByClass[cls]||{}).forEach(s => {
const tot = s.marks.filter(m => !m.isGrade).reduce((a,b)=>a+(b.grand_total||0),0);
if (tot > classTopper.total) classTopper={name:s.name,total:tot};
});
Object.values(state.studentsByClass).forEach(clsObj => {
Object.values(clsObj).forEach(s => {
const tot = s.marks.filter(m => !m.isGrade).reduce((a,b)=>a+(b.grand_total||0),0);
if (tot > schoolTopper.total) schoolTopper={name:s.name,total:tot};
});
});
qs('classTopperDashboard').textContent = `Class Topper: ${classTopper.name} — ${classTopper.total}`;
qs('schoolTopperDashboard').textContent = `School Topper: ${schoolTopper.name} — ${schoolTopper.total}`;
}
/* ---------------- BULK DOWNLOAD ---------------- */
function bulkDownloadReports() {
// This function can be expanded to show the full annual report in text format
alert("Bulk text download needs to be updated for the new Annual format. Please use the Excel download for now.");
}
/* ---------------- MODIFICATION: EXCEL DOWNLOAD FOR ANNUAL EXAM ---------------- */
function downloadMarksExcel() {
    const cls = qs('dashboardClassSelect').value || state.selectedClass;
    if (!cls) return alert('Select a class for Excel download.');
    if (!state.studentsByClass[cls] || !Object.keys(state.studentsByClass[cls]).length) return alert('No students found in this class.');
    
    const students = Object.values(state.studentsByClass[cls]);
    const isNurUkg = isNurToUkg(cls);
    
    let headers = ["Adm No", "Student", "Father", "Class", "Subject", "UT1", "HY", "T1 Total", "UT2", "AE", "T2 Total", "Grand Total", "Grade"];
    if (isNurUkg) {
        headers = ["Adm No", "Student", "Father", "Class", "Subject", "UT1", "UT1(O)", "HY", "HY(O)", "T1 Total", "UT2", "UT2(O)", "AE", "AE(O)", "T2 Total", "Grand Total", "Grade"];
    }
    let csvContent = headers.join(',') + '\n';

    students.forEach(s => {
        const studentInfo = `"${s.admission}","${s.name}","${s.fatherName}","${displayClassLabel(cls)}"`;
        s.marks.forEach(m => {
            let row = `${studentInfo},"${m.name}"`;
            if (m.isGrade) {
                row += isNurUkg ? ',,,,,,,,,,,,,Grade ' + m.grade : ',,,,,,,,Grade ' + m.grade;
            } else if (isNurUkg) {
                row += `,${m.ut1||0},${m.ut1Oral||0},${m.hy||0},${m.hyOral||0},${m.t1_total||0},${m.ut2||0},${m.ut2Oral||0},${m.ae||0},${m.aeOral||0},${m.t2_total||0},${m.grand_total||0},${m.grade||'--'}`;
            } else {
                row += `,${m.ut1||0},${m.hy||0},${m.t1_total||0},${m.ut2||0},${m.ae||0},${m.t2_total||0},${m.grand_total||0},${m.grade||'--'}`;
            }
            csvContent += row + "\n";
        });
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Annual_Marks_Class_${cls}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

/* ---------------- CLEAR DATA ---------------- */
function clearAllData() {
const password = prompt('Enter password to clear ALL data:');
if (password !== '1234') return alert('Incorrect password!');
if (!confirm('Are you sure? This will remove all saved data!')) return;
localStorage.clear();
state.studentsByClass = {};
state.selectedStudentKey = '';
state.reportPrintDate = null;
qs('reportPrintDateInput').value = '';
clearStudentView();
updatePrintDate();
alert('All data cleared successfully.');
}
/* ----------------- HELPERS: LOAD / CLEAR VIEW ----------------- */
function clearStudentView() {
state.selectedStudentKey = '';
qs('studentName').textContent = '—';
qs('admissionNo').textContent = '—';
if (qs('fatherName')) qs('fatherName').textContent = '—';
qs('studentNameInput').value = '';
qs('admissionInput').value = '';
if (qs('fatherNameInput')) qs('fatherNameInput').value = '';
qs('classSection').textContent = state.selectedClass ? displayClassLabel(state.selectedClass) : '—';
qs('attendancePresent').value = '';
qs('attendanceTotal').value = DEFAULT_ATT_TOTAL;
qs('coscholasticBody').innerHTML = `
<tr><td>Work Habits</td><td><input type="text" id="workHabitsInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full" /></td></tr>
<tr><td>Behavior</td><td><input type="text" id="behaviorInput" placeholder="e.g. A, B, C" class="border px-1 py-0.5 rounded w-full"/></td></tr>
`;
if (qs('teachersRemark')) qs('teachersRemark').textContent = 'Good effort. Keep improving.';
renderMarksTableForClass(state.selectedClass);
}

/* ----------------- UPDATE PRINT DATE ----------------- */
function updatePrintDate() {
    let dateToDisplay = state.reportPrintDate 
        ? new Date(state.reportPrintDate).toLocaleDateString('en-IN')
        : new Date().toLocaleDateString('en-IN');
    qs('printDate').textContent = 'Date: ' + dateToDisplay;
}

function setReportPrintDate() {
    const dateInput = qs('reportPrintDateInput').value;
    if (dateInput) {
        state.reportPrintDate = dateInput;
        localStorage.setItem('ng_reportPrintDate', dateInput);
        alert('Report print date set successfully!');
    } else {
        state.reportPrintDate = null;
        localStorage.removeItem('ng_reportPrintDate');
        alert('Report print date cleared. Current date will be used.');
    }
    updatePrintDate();
}

init(); 

</script>
</body>
</html>

